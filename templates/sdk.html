<!DOCTYPE html>
<html>
  <head>
    <title>Spotify Playback</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/player.css') }}">
  </head>
  <body>
    <div class="container">
      <h1>Spotify Web Player</h1>
      
      <div id="connection-status">Connecting to Spotify...</div>

      <div id="current-track-info">
          <h2 id="track-name">No Track Playing</h2>
          <p id="artist-name">-</p>
      </div>
      <button class="controls"id="previousTrack" disabled>Previous Track</button>
      <button class="controls"id="togglePlay" disabled>Play/Pause</button>
      <button class="controls"id="nextTrack" disabled>Next Track</button>

      <div id="device-info">
          <p>Device Name: <span id="device-name">-</span></p>
          <p>Device ID: <span id="device-id">-</span></p>
      </div>
    </div>
    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <script>
        window.onSpotifyWebPlaybackSDKReady = () => {
            const token = '{{access_token}}';
            const connectionStatusElement = document.getElementById('connection-status');
            const trackNameElement = document.getElementById('track-name');
            const artistNameElement = document.getElementById('artist-name');
            const togglePlayButton = document.getElementById('togglePlay');
            const NextButton = document.getElementById('nextTrack');
            const PreviousButton = document.getElementById('previousTrack');
            const deviceNameElement = document.getElementById('device-name');
            const deviceIdElement = document.getElementById('device-id');


            const updateConnectionStatus = (status, isConnected) => {
                connectionStatusElement.textContent = status;
                connectionStatusElement.className = isConnected ? 'connected' : 'disconnected';
                

                console.log(`Spotify Connection Status: ${status}`);
            };


            if (!token || token === '') {
                updateConnectionStatus('Error: No access token', false);
                return;
            }

            const player = new Spotify.Player({
                name: 'Rohan\'s Web Player', 
                getOAuthToken: cb => { cb(token); },
                volume: 0.5
            });


            player.addListener('ready', ({ device_id }) => {
                updateConnectionStatus('Connected to Spotify', true);
                

                togglePlayButton.disabled = false;
                NextButton.disabled = false;
                PreviousButton.disabled = false;

                deviceIdElement.textContent = device_id;
                deviceNameElement.textContent = 'Web Playback SDK';


                console.log('Spotify Device Connected:', {
                    deviceId: device_id,
                    deviceName: 'Web Playback SDK'
                });
            });

            player.addListener('not_ready', ({ device_id }) => {
                updateConnectionStatus('Disconnected from Spotify', false);
                togglePlayButton.disabled = true;
            });


            const errorHandlers = {
                'initialization_error': 'Initialization Error',
                'authentication_error': 'Authentication Error',
                'account_error': 'Account Error',
                'playback_error': 'Playback Error'
            };

            Object.entries(errorHandlers).forEach(([errorType, errorMessage]) => {
                player.addListener(errorType, ({ message }) => {
                    updateConnectionStatus(`${errorMessage}: ${message}`, false);
                    console.error(`Spotify ${errorMessage}:`, message);
                });
            });


            player.addListener('player_state_changed', state => {
                if (state) {
                    const track = state.track_window.current_track;
                    trackNameElement.textContent = track.name;
                    artistNameElement.textContent = track.artists.map(artist => artist.name).join(', ');
                    
                    togglePlayButton.textContent = state.paused ? 'Play' : 'Pause';
                }
            });

            togglePlayButton.onclick = () => {
                player.togglePlay().then(() => {
                    console.log('Playback Toggled');
                }).catch(error => {
                    console.error('Toggle Play Error:', error);
                    updateConnectionStatus(`Play/Pause Error: ${error.message}`, false);
                });
            };
            NextButton.onclick = () => {
                player.nextTrack().then(() => {
                    console.log('Skipped to Next Track');
                }).catch(error => {
                    console.error('Skip Next Error:', error);
                    updateConnectionStatus(`Next Track Error: ${error.message}`, false);
                });
            };
            PreviousButton.onclick = () => {
                player.previousTrack().then(() => {
                    console.log('Skipped to Previous Track');
                }).catch(error => {
                    console.error('Skip Previous Error:', error);
                    updateConnectionStatus(`Previous Track Error: ${error.message}`, false);
                });
            };

            player.connect().then(success => {
                if (success) {
                    console.log('Spotify SDK Connection Initiated');
                } else {
                    updateConnectionStatus('Failed to Connect to Spotify', false);
                }
            }).catch(error => {
                updateConnectionStatus(`Connection Error: ${error}`, false);
            });
        };
    </script>
  </body>
</html>